<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Changi Virtual Assist</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fb;color:#1a2b3c;margin:0}
    header{padding:16px;background:#fff;border-bottom:1px solid #e6eef5}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .status-badge{float:right;padding:6px 12px;border-radius:16px;font-weight:600;color:#fff;transition:all 0.3s}
    .status-badge.rnn{background:#10b981}
    .status-badge.demo{background:#ffb84d}
    .status-badge.loading{background:#94a3b8}
    .chat{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(26,43,60,0.06);min-height:420px;display:flex;flex-direction:column}
    #messages{flex:1;overflow:auto;padding:12px;border-radius:8px;max-height:500px}
    .message{margin:8px 0;padding:10px;border-radius:10px;max-width:75%;animation:fadeIn 0.3s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .message-user{background:#0052cc;color:#fff;margin-left:auto}
    .message-assistant{background:#eef6ff;color:#0b2b54;margin-right:auto}
    .input-area{display:flex;gap:8px;margin-top:12px}
    textarea{flex:1;padding:10px;border-radius:8px;border:1px solid #e1e8ed;resize:none;font-family:inherit}
    button{background:#0052cc;color:#fff;padding:10px 16px;border-radius:8px;border:none;cursor:pointer;transition:background 0.2s}
    button:hover{background:#003d99}
    button:disabled{background:#94a3b8;cursor:not-allowed}
    .debug{background:#fff7e6;padding:8px;border:1px dashed #ffd59e;margin-top:12px;border-radius:8px;font-size:12px;font-family:monospace}
    .confidence{font-size:11px;color:#64748b;margin-top:4px}
    .typing{display:none;padding:10px;background:#eef6ff;border-radius:10px;max-width:75px;margin:8px 0}
    .typing.show{display:block}
    .typing span{display:inline-block;width:8px;height:8px;border-radius:50%;background:#0052cc;animation:bounce 1.4s infinite;margin:0 2px}
    .typing span:nth-child(2){animation-delay:0.2s}
    .typing span:nth-child(3){animation-delay:0.4s}
    @keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 style="display:inline-block">Changi Virtual Assist</h1>
      <div class="status-badge loading" id="statusBadge">Connecting...</div>
    </div>
  </header>

  <div class="container">
    <div class="chat">
      <div id="messages">
        <div class="message message-assistant">ðŸ‘‹ Welcome! I'm your Changi Airport assistant. Ask me about flights, gates, transport, or airport services.</div>
      </div>

      <div class="typing" id="typingIndicator">
        <span></span><span></span><span></span>
      </div>

      <div class="input-area">
        <textarea id="userInput" rows="1" placeholder="Ask about flights, gates, luggage or transport..."></textarea>
        <button id="sendButton">Send</button>
      </div>
      <div class="debug" id="debugBox">Checking server status...</div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api/predict';
    const HEALTH_URL = 'http://localhost:5000/api/health';
    
    let currentMode = 'loading';
    let isProcessing = false;

    // Check server health on load
    async function checkHealth() {
      try {
        const response = await fetch(HEALTH_URL);
        const data = await response.json();
        
        currentMode = data.mode || 'demo';
        updateStatusBadge(currentMode, data);
        updateDebugInfo(data);
      } catch (error) {
        console.error('Health check failed:', error);
        currentMode = 'error';
        updateStatusBadge('error', {message: 'Server not responding'});
        updateDebugInfo({error: 'Cannot connect to server'});
      }
    }

    function updateStatusBadge(mode, data) {
      const badge = document.getElementById('statusBadge');
      badge.className = 'status-badge ' + mode;
      
      if (mode === 'rnn') {
        badge.textContent = 'ðŸ§  RNN Mode';
        badge.title = 'Using trained neural network with ' + (data.message || '');
      } else if (mode === 'demo') {
        badge.textContent = 'âš¡ Demo Mode';
        badge.title = 'Using keyword matching (RNN model not loaded)';
      } else if (mode === 'error') {
        badge.textContent = 'âŒ Offline';
        badge.title = data.message || 'Server error';
      } else {
        badge.textContent = 'â³ Loading...';
      }
    }

    function updateDebugInfo(data) {
      const debugBox = document.getElementById('debugBox');
      if (data.mode === 'rnn') {
        debugBox.textContent = `Mode: RNN | Device: ${data.device || 'cpu'} | Status: ${data.status || 'ready'}`;
        debugBox.style.background = '#dcfce7';
        debugBox.style.borderColor = '#86efac';
      } else if (data.mode === 'demo') {
        debugBox.textContent = `Mode: Demo (keyword-based) | Status: ${data.status || 'active'}`;
        debugBox.style.background = '#fff7e6';
        debugBox.style.borderColor = '#ffd59e';
      } else if (data.error) {
        debugBox.textContent = `Error: ${data.error}`;
        debugBox.style.background = '#fee';
        debugBox.style.borderColor = '#fcc';
      }
    }

    function addMessage(text, isUser = false, confidence = null) {
      const messagesDiv = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ' + (isUser ? 'message-user' : 'message-assistant');
      messageDiv.textContent = text;
      
      if (confidence && !isUser) {
        const confSpan = document.createElement('div');
        confSpan.className = 'confidence';
        confSpan.textContent = `Confidence: ${confidence.toFixed(1)}%`;
        messageDiv.appendChild(confSpan);
      }
      
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTyping(show) {
      document.getElementById('typingIndicator').className = show ? 'typing show' : 'typing';
    }

    async function sendMessage(text) {
      if (isProcessing) return;
      isProcessing = true;
      
      try {
        showTyping(true);
        
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({query: text})
        });
        
        showTyping(false);
        
        if (response.ok) {
          const data = await response.json();
          
          // Update mode if it changed
          if (data.mode && data.mode !== currentMode) {
            currentMode = data.mode;
            updateStatusBadge(data.mode, {message: `Using ${data.mode} mode`});
          }
          
          const confidence = data.predictions && data.predictions[0] ? data.predictions[0].confidence : null;
          addMessage(data.response || 'Sorry, I could not process that request.', false, confidence);
          
          // Update debug with prediction details
          if (data.predictions && data.predictions.length > 0) {
            const top3 = data.predictions.slice(0, 3).map(p => `${p.intent}(${p.confidence.toFixed(0)}%)`).join(', ');
            const debugBox = document.getElementById('debugBox');
            debugBox.textContent = `Mode: ${data.mode || currentMode} | Top intents: ${top3}`;
          }
          
          return data.response;
        } else {
          addMessage('Sorry, there was an error processing your request.', false);
          return null;
        }
      } catch (error) {
        showTyping(false);
        console.error('Error:', error);
        addMessage('Sorry, I could not connect to the server. Please check if the server is running.', false);
        return null;
      } finally {
        isProcessing = false;
      }
    }

    document.getElementById('sendButton').addEventListener('click', async () => {
      const input = document.getElementById('userInput');
      const txt = input.value.trim(); 
      if (!txt || isProcessing) return;
      
      addMessage(txt, true);
      input.value = '';
      
      await sendMessage(txt);
    });

    document.getElementById('userInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('sendButton').click();
      }
    });

    // Auto-resize textarea
    document.getElementById('userInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Check health on page load
    checkHealth();
    
    // Recheck health every 30 seconds
    setInterval(checkHealth, 30000);
  </script>
</body>
</html>