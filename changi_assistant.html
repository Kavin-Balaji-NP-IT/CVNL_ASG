<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Changi Virtual Assist (Demo)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fb;color:#1a2b3c;margin:0}
    header{padding:16px;background:#fff;border-bottom:1px solid #e6eef5}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .status-badge{float:right;background:#ffb84d;color:#fff;padding:6px 12px;border-radius:16px;font-weight:600}
    .chat{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(26,43,60,0.06);min-height:420px;display:flex;flex-direction:column}
    #messages{flex:1;overflow:auto;padding:12px;border-radius:8px}
    .message{margin:8px 0;padding:10px;border-radius:10px;max-width:75%}
    .message-user{background:#0052cc;color:#fff;margin-left:auto}
    .message-assistant{background:#eef6ff;color:#0b2b54;margin-right:auto}
    .input-area{display:flex;gap:8px;margin-top:12px}
    textarea{flex:1;padding:10px;border-radius:8px;border:1px solid #e1e8ed;resize:none}
    button{background:#0052cc;color:#fff;padding:10px 16px;border-radius:8px;border:none;cursor:pointer}
    .debug{background:#fff7e6;padding:8px;border:1px dashed #ffd59e;margin-top:12px;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 style="display:inline-block">Changi Virtual Assist</h1>
      <div class="status-badge" id="statusBadge">Demo Mode</div>
    </div>
  </header>

  <div class="container">
    <div class="chat">
      <div id="messages">
        <div class="message message-assistant">ðŸ‘‹ Welcome! This page is running in demo mode. Try typing: "Where is gate A15?"</div>
      </div>

      <div class="input-area">
        <textarea id="userInput" rows="1" placeholder="Ask about flights, gates, luggage or transport..."></textarea>
        <button id="sendButton">Send</button>
      </div>
      <div class="debug" id="debugBox">Debug: backendAvailable = false</div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api/predict';
    let backendAvailable = false;

    function updateStatus() {
      const b = document.getElementById('statusBadge');
      b.textContent = backendAvailable ? 'Model Ready' : 'Demo Mode';
      b.style.background = backendAvailable ? '#00b87c' : '#ffb84d';
      document.getElementById('debugBox').textContent = 'Debug: backendAvailable = ' + backendAvailable;
    }

    function addMessage(text, isUser=false) {
      const m = document.createElement('div');
      m.className = 'message ' + (isUser ? 'message-user' : 'message-assistant');
      m.textContent = text;
      document.getElementById('messages').appendChild(m);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    async function classifyIntent(text) {
      if (!backendAvailable) {
        // simple demo keyword-based fallback
        const t = text.toLowerCase();
        let intent = 'flight';
        if (t.includes('time')||t.includes('when')) intent = 'flight_time';
        if (t.includes('taxi')||t.includes('bus')||t.includes('mrt')) intent = 'ground_service';
        return {predictions:[{intent:intent,confidence:85}],response:"(Demo) I think you are asking about " + intent};
      }

      try {
        const r = await fetch(API_URL, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:text})});
        return await r.json();
      } catch(e) {
        console.warn('API error',e);
        backendAvailable = false; updateStatus();
        return classifyIntent(text);
      }
    }

    document.getElementById('sendButton').addEventListener('click', async ()=>{
      const input = document.getElementById('userInput');
      const txt = input.value.trim(); if(!txt) return;
      addMessage(txt, true);
      input.value = '';
      const res = await classifyIntent(txt);
      addMessage(res.response || '(No response)');
    });

    document.getElementById('userInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('sendButton').click(); } });

    // quick backend probe
    (async function checkBackend(){
      try {
        const r = await fetch('http://127.0.0.1:5000/api/health');
        if (r.ok) backendAvailable = true; else backendAvailable = false;
      } catch(e){ backendAvailable = false; }
      updateStatus();
    })();
  </script>
</body>
</html>